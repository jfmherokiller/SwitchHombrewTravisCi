language: cpp
notifications:
  email: false
  
matrix:
  include:
    # windows platform
    - os: windows
      before_install:
        - |-
          case $TRAVIS_OS_NAME in
            windows)
              [[ ! -f C:/tools/msys64/msys2_shell.cmd ]] && rm -rf C:/tools/msys64
              choco uninstall -y mingw
              choco upgrade --no-progress -y msys2
              export msys2='cmd //C RefreshEnv.cmd '
              export msys2+='& set MSYS=winsymlinks:nativestrict '
              export msys2+='& C:\\tools\\msys64\\msys2_shell.cmd -defterm -no-start'
              export mingw64="$msys2 -mingw64 -full-path -here -c "\"\$@"\" --"
              export msys2+=" -msys2 -c "\"\$@"\" --"
              $msys2 pacman-key --recv F7FD5492264BB9D0
              $msys2 pacman-key --lsign F7FD5492264BB9D0
              $msys2 pacman --noconfirm -U https://downloads.devkitpro.org/devkitpro-keyring-r1.787e015-2-any.pkg.tar.xz
              $msys2 bash -c "echo \"[dkp-libs]\" >> /C/tools/msys64/etc/pacman.conf"
              $msys2 bash -c "echo \"Server = https://downloads.devkitpro.org/packages\" >> /C/tools/msys64/etc/pacman.conf" 
              $msys2 bash -c "echo \"[dkp-windows]\" >> /C/tools/msys64/etc/pacman.conf"
              $msys2 bash -c "echo \"Server = https://downloads.devkitpro.org/packages/windows\" >> /C/tools/msys64/etc/pacman.conf"
              ## $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-toolchain
              $msys2 pacman -Syu --noconfirm
              ## Install more MSYS2 packages from https://packages.msys2.org/base here
              $msys2 pacman --sync --noconfirm --needed switch-dev
              $msys2 pacman --sync --noconfirm --needed cmake make
              taskkill //IM gpg-agent.exe //F  # https://travis-ci.community/t/4967
              export DEVKITPRO=/C/tools/msys64/opt/devkitpro
              export DEVKITARM=${DEVKITPRO}/devkitARM
              export DEVKITPPC=${DEVKITPRO}/devkitPPC
              export DEVKITA64=${DEVKITPRO}/devkitA64
              export PATH=/C/tools/msys64/mingw64/bin:$PATH
              export PATH=${DEVKITPRO}/tools/bin:$PATH
              ## export MAKE=mingw32-make  # so that Autotools can find it
              ;;
          esac

      before_cache:
        - |-
          case $TRAVIS_OS_NAME in
            windows)
              # https://unix.stackexchange.com/a/137322/107554
              $msys2 pacman --sync --clean --noconfirm
              $msys2 rm /C/tools/msys64/var/log/pacman.log
              ;;
          esac

      cache:
        directories:
          - $HOME/AppData/Local/Temp/chocolatey
          - /C/tools/msys64
      script:
        - $msys2 make
        - $msys2 ps -W | sort